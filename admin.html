<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投稿画面 | シニアメイトの楽屋裏</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Admin specific styles */
        .admin-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--color-text);
        }

        input[type="text"],
        input[type="date"],
        textarea,
        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            font-family: inherit;
        }

        textarea {
            height: 200px;
            resize: vertical;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }

        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .error {
            background-color: #ffebee;
            color: #c62828;
        }

        .preview-img {
            max-width: 200px;
            margin-top: 10px;
            border-radius: 4px;
            display: none;
        }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="container header-inner">
            <span class="site-title">シニアメイトの楽屋裏 - 投稿</span>
            <a href="index.html" target="_blank" style="font-size: 0.9rem;">サイトを見る &rarr;</a>
        </div>
    </header>

    <div class="container admin-container">
        <h2 class="section-title">記事を投稿する</h2>

        <div class="form-group">
            <label>タイトル</label>
            <input type="text" id="post-title" placeholder="例：春のお茶会をしました">
        </div>

        <div class="form-group">
            <label>日付</label>
            <input type="date" id="post-date">
        </div>

        <div class="form-group">
            <label>自己紹介（支部・地区・パーティ・学年）</label>
            <input type="text" id="post-author-info" placeholder="例：関東支部 千葉地区 大学2年生">
        </div>

        <div class="form-group">
            <label>あだ名</label>
            <input type="text" id="post-name" placeholder="例：さくら">
        </div>

        <!-- Category Field -->
        <div class="form-group">
            <label for="post-category">カテゴリー</label>
            <select id="post-category">
                <option value="preparation">準備</option>
                <option value="thoughts">感想</option>
            </select>
        </div>

        <div class="form-group">
            <label>写真</label>
            <input type="file" id="post-image-file" accept="image/*">
            <img id="image-preview" class="preview-img" alt="プレビュー">
        </div>

        <div class="form-group">
            <label>本文</label>
            <textarea id="post-content" placeholder="ここに本文を入力してください。"></textarea>
            <p class="helper-text" style="font-size: 0.85rem; color: #888; margin-top: 5px;">※自動的に改行されます。</p>
        </div>

        <div class="text-center" style="margin-top: 20px;">
            <button onclick="submitPost()" id="submit-btn" class="btn">公開する</button>
            <p style="margin-top: 10px; font-size: 0.8rem; color: #888;">
                <button onclick="testConnection()"
                    style="background:none; border:none; text-decoration:underline; cursor:pointer;">接続テストを実行する</button>
            </p>
        </div>

        <div id="status-message"></div>
    </div>

    <script>
        const SERVICE_DOMAIN = "seniormate1";
        const API_KEY = "5NktcNmkaRcjELDE8KN0krYXRWgu7x2mCO3U";
        const API_ENDPOINT = "blog";

        async function testConnection() {
            showStatus('接続テスト中...', 'normal');
            try {
                const res = await fetch(`https://${SERVICE_DOMAIN}.microcms.io/api/v1/${API_ENDPOINT}?limit=1`, {
                    headers: { 'X-MICROCMS-API-KEY': API_KEY }
                });
                if (res.ok) {
                    alert('接続成功！APIキーは正しく認識されています。');
                    showStatus('', 'normal');
                } else {
                    alert(`接続失敗: Status ${res.status}`);
                }
            } catch (e) {
                alert(`接続エラー: ${e.message}\nもし「Failed to fetch」の場合は、ブラウザの拡張機能(AdBlockなど)が邪魔しているか、セキュリティ設定の問題の可能性があります。`);
            }
        }

        document.getElementById('post-date').valueAsDate = new Date();

        document.getElementById('post-image-file').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('image-preview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });

        async function submitPost() {
            const btn = document.getElementById('submit-btn');

            const title = document.getElementById('post-title').value;
            const date = document.getElementById('post-date').value;
            const content = document.getElementById('post-content').value;
            const fileInput = document.getElementById('post-image-file');
            const authorInfo = document.getElementById('post-author-info').value;
            const name = document.getElementById('post-name').value;
            const category = document.getElementById('post-category').value;

            if (!title || !content || !authorInfo || !name) {
                showStatus('タイトル、本文、自己紹介、あだ名はすべて必須です。', 'error');
                return;
            }

            // MicroCMS Schema requires an image (based on recent error)
            if (fileInput.files.length === 0) {
                showStatus('MicroCMSの設定で「画像」が必須になっています。\n写真を1枚選択してください。', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = '送信中...';
            showStatus('処理を開始します...', 'success');

            try {
                let imageId = null;

                // 1. Image Upload
                if (fileInput.files.length > 0) {
                    showStatus('画像をアップロード中...', 'success');
                    const file = fileInput.files[0];
                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const uploadRes = await fetch('https://upload.microcms.io/api/v1/media', {
                            method: 'POST',
                            headers: { 'X-MICROCMS-API-KEY': API_KEY },
                            body: formData
                        });

                        if (!uploadRes.ok) {
                            throw new Error(`画像アップロード失敗 (Status: ${uploadRes.status})。APIキーの「media」権限でPOSTが許可されているか確認してください。`);
                        }
                        const uploadData = await uploadRes.json();
                        imageId = uploadData.url;
                    } catch (uploadError) {
                        console.error(uploadError);
                        // Abort if image failed (optional, user might want to proceed without image)
                        if (!confirm(`画像のアップロードに失敗しました。\n詳細: ${uploadError.message}\n\n画像なしで記事だけ投稿を続けますか？`)) {
                            throw new Error('キャンセルされました');
                        }
                    }
                }

                // 2. Create Article
                showStatus('記事を作成中...', 'success');
                const formattedContent = content.split('\n').filter(line => line.trim() !== '').map(line => `<p>${line}</p>`).join('');

                const postData = {
                    title: title,
                    published_date: date,
                    publishedAt: new Date().toISOString(),
                    publishedAt: new Date().toISOString(),
                    publishedAt: new Date().toISOString(),
                    author_info: document.getElementById('post-author-info').value,
                    name: document.getElementById('post-name').value,
                    category: [category], // MicroCMS Select field expects an array
                    content: formattedContent,
                    image: imageId // Can be null
                };

                const createRes = await fetch('/api/proxy_blog', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });

                if (!createRes.ok) {
                    const errData = await createRes.json();
                    console.error("Create API Error:", errData);
                    // Try to extract helpful message
                    let errorDetail = "";
                    if (errData.details) errorDetail = "\n詳細: " + JSON.stringify(errData.details);
                    if (errData.message) errorDetail += "\nMessage: " + errData.message;

                    throw new Error(`記事作成失敗 (Status: ${createRes.status})。${errorDetail}\nAPIスキーマの設定（フィールドIDなど）がコードと一致しているか確認してください。`);
                }

                showStatus('✅ 投稿が完了しました！トップページに戻ります。', 'success');

                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = '公開する';
                    window.location.href = 'index.html';
                }, 2000);

            } catch (error) {
                console.error(error);
                showStatus(`エラー: ${error.message}`, 'error');
                btn.disabled = false;
                btn.textContent = '公開する';
            }
        }

        function showStatus(msg, type) {
            const el = document.getElementById('status-message');
            el.textContent = msg;
            el.className = type === 'normal' ? '' : type;
            el.style.display = 'block';
        }
    </script>
</body>